# 🥬 蔬菜公司Excel助手 - 完整文档

## 📋 目录

1. [系统简介](#系统简介)
2. [功能特点](#功能特点)
3. [快速开始](#快速开始)
4. [详细使用](#详细使用)
5. [智能匹配规则](#智能匹配规则)
6. [定价表格式说明](#定价表格式说明)
7. [前缀自动匹配功能](#前缀自动匹配功能)
8. [OCR功能说明](#ocr功能说明)
9. [故障排除](#故障排除)
10. [版本更新记录](#版本更新记录)
11. [Bug修复记录](#bug修复记录)
12. [文件说明](#文件说明)

---

## 系统简介

蔬菜公司Excel助手是一个专为蔬菜批发/配送公司设计的利润计算工具。它能自动解析订单文字、匹配价格、计算利润，并生成专业的Excel报表。

### 适用场景
- 学校食堂蔬菜配送
- 企业食堂采购
- 农贸批发业务
- 任何需要快速计算蔬菜订单利润的场景

---

## 功能特点

### ✅ 核心功能

1. **文字列表智能解析**
   - 自动识别单位名称
   - 提取菜品和数量
   - 支持多单位批量处理

2. **定价表双模式**
   - 📷 **图片OCR识别**：使用腾讯云OCR自动识别价格表截图
   - 📊 **Excel直接上传**：快速导入定价表Excel文件
   - 灵活选择，满足不同场景

3. **智能菜品匹配**
   - 汉字完全匹配
   - 编号模糊匹配
   - 自动忽略前缀
   - 支持规格匹配
   - 解决菜品规格多样化问题

4. **自动利润计算**
   - 计算单品利润
   - 统计总利润
   - 按单位分组展示
   - 支持规格通用匹配（进价）

5. **专业Excel报表**
   - 格式美观，色彩分明
   - 自动调整列宽
   - 包含完整利润明细

---

## 快速开始

### 🎉 v2.1 重大更新

#### ✅ 已修复的问题

1. **定价显示0的问题** 
   - ✅ 已支持4列双列格式定价表
   - ✅ 自动读取所有菜品（不会丢失第3-4列数据）

2. **前缀不匹配的问题**
   - ✅ 订单`白萝卜` 可自动匹配 定价表`XS-白萝卜`
   - ✅ 支持所有常见前缀（XS-、JX-、JS-等）

3. **规格通用匹配**
   - ✅ 进价支持规格通用匹配（如"大白菜一级品"匹配"大白菜"的进价）
   - ✅ 定价保持精确匹配规格

### 第一步：安装依赖

```bash
cd /Users/guozuxiao/Documents/蔬菜小助手/company
pip3 install -r requirements.txt
```

### 第二步：启动程序

**方式A：双击启动（推荐）**
```
双击 "启动程序.command" 文件
```

**方式B：命令行启动**
```bash
python3 main.py
```

### 第三步：验证功能

运行快速验证测试：
```bash
cd /Users/guozuxiao/Documents/蔬菜小助手/company
python3 快速验证测试.py
```

如果看到"🎉 所有测试通过！"，说明功能正常！

### 第四步：正常使用

1. **输入订单文字**
   - 订单中可以不写前缀
   - 例如：`白萝卜 20斤`、`菠菜 15斤`、`大白菜一级品 20斤`

2. **上传定价表**
   - 定价表可以有前缀（如`XS-白萝卜`）
   - 也可以没有前缀（如`白萝卜`）
   - 2列或4列格式都支持

3. **上传进价表**
   - 同上，支持有无前缀
   - 支持规格通用匹配

4. **生成利润表**
   - 定价不会再显示0
   - 所有菜品都能正确匹配

---

## 详细使用

### 1️⃣ 文字列表输入

**格式要求：**
```
单位名称
菜品名+数量+斤
菜品名+数量+斤
...

另一个单位名称
菜品名+数量+斤
...
```

**实际示例：**
```
一中五食堂
胡萝卜20斤
尖椒1号15斤
黄瓜10斤

综合四食堂
西红柿30斤
茄子25斤
土豆20斤
```

**也支持没有单位的格式：**
```
胡萝卜20斤
尖椒15斤
```
系统会自动标记为"未指定单位"

**注意事项：**
- 单位名称单独一行
- 每个菜品占一行
- 必须包含数量和"斤"字
- 支持小数（如：20.5斤）

### 2️⃣ 定价表上传

#### 方式A：图片OCR识别

**适用场景：**
- 只有定价表截图
- 无法获取原始Excel
- 临时价格查询

**操作步骤：**
1. 点击"📷 上传图片（OCR识别）"
2. 选择定价表截图（PNG、JPG、JPEG、BMP）
3. 等待OCR识别完成
4. 查看识别结果

**图片要求：**
- 清晰可读
- 包含菜品名和价格
- 建议正面拍摄，避免倾斜

#### 方式B：Excel文件上传

**适用场景：**
- 有定价表Excel文件
- 需要精确价格
- 批量处理订单

**操作步骤：**
1. 点击"📊 上传Excel"
2. 选择定价表Excel文件
3. 自动读取完成

### 3️⃣ 进价表上传

**操作步骤：**
1. 点击"上传Excel"
2. 选择进价表Excel文件

**Excel格式：**
| 菜品 | 进价 |
|------|------|
| 胡萝卜 | 3.0 |
| 尖椒1号 | 5.0 |
| 黄瓜A级 | 4.0 |

- 格式与定价表相同
- 建议菜品名称保持一致
- **支持规格通用匹配**：如"大白菜一级品"可匹配"大白菜"的进价

### 4️⃣ 生成利润表

**操作步骤：**
1. 确认三项数据都已准备
2. 点击"🚀 生成利润表"
3. 选择保存位置
4. 查看生成的Excel文件

**输出格式：**
| 单位 | 菜品 | 数量 | 定价 | 进价 | 单品利润 | 总利润 | 总金额 |
|------|------|------|------|------|----------|--------|--------|
| 一中五食堂 | 胡萝卜 | 20 | 5 | 3 | 2 | 40 | 100 |
| 一中五食堂 | 尖椒1号 | 15 | 8 | 5 | 3 | 45 | 120 |
| 综合四食堂 | 黄瓜 | 10 | 6 | 4 | 2 | 20 | 60 |
| **总计** | | | | | | **105** | **280** |

---

## 智能匹配规则

### 匹配原理

系统采用**"汉字完全匹配 + 编号模糊匹配"**算法：

1. **提取规则**
   - 汉字部分：开头的连续汉字（菜品主名）
   - 编号部分：后续的所有字符（数字、字母、号级等）

2. **匹配优先级**
   - ① 完全匹配（汉字+编号都一致）
   - ② 编号包含匹配（汉字一致，编号部分包含）
   - ③ 仅汉字匹配（汉字一致，编号不同或无编号）
   - ④ 汉字包含匹配（如"白菜"匹配"大白菜"）

### 匹配示例

假设定价表包含：
- 胡萝卜：¥5.0
- 尖椒1号：¥8.0
- 尖椒2号：¥9.0
- 黄瓜A级：¥6.0

订单匹配结果：

| 订单菜品 | 匹配到 | 价格 | 匹配类型 |
|---------|--------|------|---------|
| 胡萝卜 | 胡萝卜 | ¥5.0 | 完全匹配 |
| 尖椒1号 | 尖椒1号 | ¥8.0 | 完全匹配 |
| 尖椒 | 尖椒1号 | ¥8.0 | 汉字匹配 |
| 尖椒2号 | 尖椒2号 | ¥9.0 | 完全匹配 |
| 黄瓜 | 黄瓜A级 | ¥6.0 | 汉字匹配 |
| 土豆 | - | 000000 | 无匹配 |

### 命名建议

为了获得最佳匹配效果：
1. 主菜品名用汉字：胡萝卜、尖椒、黄瓜
2. 规格编号放后面：尖椒1号、黄瓜A级、茄子一级
3. 定价表和进价表使用相同命名

---

## 定价表格式说明

系统自动识别以下两种定价表格式，无需手动设置。

### 格式1：标准2列格式

**适用场景：** 菜品数量较少（<30个）

**Excel结构：**
| A列（菜品） | B列（定价） |
|-------------|-------------|
| 胡萝卜      | 5.0         |
| 尖椒1号     | 8.0         |
| 黄瓜A级     | 6.0         |
| 西红柿      | 4.0         |

**特点：**
- 简单直观
- 第一列：菜品名称
- 第二列：定价（数字）
- 可以有表头行（如：菜品|定价）

### 格式2：双列4列格式

**适用场景：** 菜品数量较多（>30个），节省空间

**Excel结构：**
| A列（菜品1）    | B列（定价1） | C列（菜品2）    | D列（定价2） |
|-----------------|--------------|-----------------|--------------|
| XS-白萝卜       | 0.9          | XS-丝瓜         | 5.4          |
| XS-菠菜         | 2.4          | XS-莴笋         | 2.9          |
| XS-大白菜       | 0.9          | XS-西红柿       | 2.9          |
| XS-菜花         | 2.7          | XS-西葫芦       | 2.6          |

**特点：**
- 紧凑布局，节省空间
- 第1-2列：第一组菜品-定价对
- 第3-4列：第二组菜品-定价对
- 可以有表头行（如：品名|单价|品名|单价）
- 参考示例：`结果表格-2.xlsx`

### 自动识别逻辑

系统会自动检测Excel文件的列数：

1. **如果有4列或更多**
   - 识别为双列格式
   - 同时读取A-B列和C-D列
   - 合并到一个定价字典中

2. **如果只有2-3列**
   - 识别为标准格式
   - 读取前两列作为菜品和定价

3. **表头识别**
   - 自动检测第一行是否为表头
   - 如果包含"品名"、"菜品"、"单价"等关键词，自动跳过

### 使用建议

#### ✅ 推荐做法

1. **菜品命名规范**
   - 主名在前（汉字）：胡萝卜、尖椒、黄瓜
   - 规格在后：1号、2号、A级、一级品
   - 示例：`XS-白萝卜(一级品)`

2. **格式选择**
   - 数据少用2列：清晰明了
   - 数据多用4列：节省空间
   - 两种格式都能自动识别

3. **数据质量**
   - 确保价格列只包含数字
   - 避免空行和空白单元格
   - 菜品名称不要包含特殊字符

#### ❌ 避免的问题

1. **价格格式错误**
   ```
   ❌ "5元"、"¥5"  → 无法识别
   ✅ "5"、"5.0"   → 正确
   ```

2. **混合格式**
   ```
   ❌ 在同一文件中混用不同格式
   ✅ 统一使用一种格式
   ```

3. **菜品名称不一致**
   ```
   ❌ 定价表：胡萝卜  订单：胡萝卜丝  → 无法匹配
   ✅ 定价表：胡萝卜  订单：胡萝卜    → 正确匹配
   ```

---

## 前缀自动匹配功能

### ✨ 功能简介

现在系统可以**自动忽略菜品名称前缀**，解决定价表和订单命名不一致的问题！

#### 典型场景

**问题：** 
- 定价表中菜品有前缀：`XS-白萝卜`、`XS-菠菜`、`XS-西红柿`
- 订单中菜品无前缀：`白萝卜`、`菠菜`、`西红柿`
- 导致匹配失败，定价显示0

**解决方案：**
- 系统自动去除前缀进行匹配
- 订单`白萝卜` ✅ 自动匹配 定价表`XS-白萝卜`

### 🔧 支持的前缀格式

系统自动识别并忽略以下格式的前缀：

- `XS-` (徐水)
- `JX-` (巨鑫)
- `JS-` (金盛)
- `XY-` (鑫源)
- `YS-` (亿盛)
- `[嘉泽] XS-` (复杂前缀)
- 等等...

**格式规则：** 2-3个大写或小写字母 + 短横线 `-`，也支持括号前缀

### 📊 匹配优先级

系统按照以下优先级进行匹配：

#### 1️⃣ 完全匹配（最高优先级）
```
订单：XS-白萝卜  ↔  定价表：XS-白萝卜  ✅
```
包括前缀在内完全一致

#### 2️⃣ 去前缀完全匹配
```
订单：白萝卜  ↔  定价表：XS-白萝卜  ✅
订单：菠菜   ↔  定价表：JX-菠菜   ✅
```
去除前缀后完全一致

#### 3️⃣ 规格标准化匹配
```
订单：大白菜一级品  ↔  定价表：XS-大白菜(一级品)  ✅
```
自动标准化规格格式进行匹配

#### 4️⃣ 编号包含匹配
```
订单：白萝卜(一级)  ↔  定价表：XS-白萝卜(一级品)  ✅
```
汉字一致，编号部分包含

#### 5️⃣ 仅汉字匹配（最低优先级）
```
订单：白萝卜  ↔  定价表：XS-白萝卜(一级品)  ✅
```
只匹配汉字部分

### 💡 实际示例

#### 示例1：标准匹配

**定价表内容：**
```
XS-白萝卜          0.9
XS-白萝卜(一级品)   1.4
XS-菠菜            2.4
XS-西红柿          2.9
```

**订单内容：**
```
一中五食堂
白萝卜 20斤
菠菜 15斤
西红柿 10斤
```

**匹配结果：**
- 白萝卜 → XS-白萝卜 (¥0.9) ✅
- 菠菜 → XS-菠菜 (¥2.4) ✅
- 西红柿 → XS-西红柿 (¥2.9) ✅

#### 示例2：带规格匹配

**定价表内容：**
```
XS-白萝卜(一级品)   1.4
XS-菠菜(一级品)     3.9
```

**订单内容：**
```
白萝卜一级品 20斤
菠菜一级品 15斤
```

**匹配结果：**
- 白萝卜一级品 → XS-白萝卜(一级品) (¥1.4) ✅
- 菠菜一级品 → XS-菠菜(一级品) (¥3.9) ✅

#### 示例3：复杂前缀匹配

**定价表内容：**
```
[嘉泽] XS-白萝卜   0.9
[嘉泽] XS-菠菜     2.4
黄瓜               6.0  (无前缀)
```

**订单内容：**
```
白萝卜 20斤
菠菜 15斤
黄瓜 10斤
```

**匹配结果：**
- 白萝卜 → [嘉泽] XS-白萝卜 (¥0.9) ✅
- 菠菜 → [嘉泽] XS-菠菜 (¥2.4) ✅
- 黄瓜 → 黄瓜 (¥6.0) ✅

### ⚙️ 技术细节

#### 前缀去除逻辑
```python
# 自动去除前缀
[嘉泽] XS-白萝卜 → 白萝卜
XS-白萝卜 → 白萝卜
JX-菠菜 → 菠菜
xs-西红柿 → 西红柿 (不区分大小写)
```

#### 规格标准化
```python
# 自动标准化规格
大白菜一级品 → 大白菜(一级品)
白萝卜(一级品) → 白萝卜(一级品)
```

#### 匹配流程
1. 先尝试完全匹配（包括前缀）
2. 去除前缀后再次尝试完全匹配
3. 标准化规格信息后再尝试匹配
4. 提取汉字和编号部分进行模糊匹配
5. 返回匹配度最高的结果

### 🎯 使用方法

#### 步骤1：重启程序
```bash
cd /Users/guozuxiao/Documents/蔬菜小助手/company
./重启程序.sh
```
或
```bash
python3 main.py
```

#### 步骤2：上传定价表
- 点击"📊 上传Excel"
- 选择您的定价表（可以有前缀，如XS-）

#### 步骤3：输入订单
- 订单中可以不写前缀
- 系统会自动匹配

#### 步骤4：生成利润表
- 点击"🚀 生成利润表"
- 查看结果，定价不会再显示0

### ✅ 验证方法

#### 快速测试
```bash
cd /Users/guozuxiao/Documents/蔬菜小助手/company
python3 -c "
from price_table_handler import read_price_excel
from matcher import find_matching_price

# 读取定价表
price_table = read_price_excel('定价/定价.xlsx')

# 测试匹配
test_items = ['白萝卜', '菠菜', '西红柿', '大白菜', '大白菜一级品']
for item in test_items:
    price = find_matching_price(item, price_table)
    print(f'{item:15s} -> ¥{price}')
"
```

#### 预期结果
```
白萝卜           -> ¥0.8
菠菜            -> ¥3.0
西红柿           -> ¥2.7
大白菜           -> ¥0.8
大白菜一级品        -> ¥1.1
```

如果显示具体价格（不是000000），说明功能正常！

### ⚠️ 注意事项

#### 1. 必须重启程序
修改代码后，**必须关闭旧程序并重新启动**，否则使用的是旧代码。

#### 2. 前缀格式
- 支持：`XS-`、`JX-`、`ABC-`、`[嘉泽] XS-` 等
- 不支持：`X_`、`XS.`、`XS` (必须有短横线)

#### 3. 匹配原则
- 汉字部分必须完全一致
- 前缀可以不同或缺失
- 编号部分可以模糊匹配

#### 4. 建议
- 如果可能，统一命名格式更好
- 但现在即使不统一也能正常匹配

---

## OCR功能说明

### 📋 功能简介

系统支持通过OCR技术识别定价表图片，自动提取菜品名称和价格信息。

### 🔧 技术实现

#### 修复内容

通过调试发现，OCR API工作正常，能够识别图片中的文字，但是：

**OCR返回的数据格式：**
```
S-白萝卜
0.9
s-丝瓜
5.4
```

**原代码期望的格式：**
```
S-白萝卜 0.9
s-丝瓜 5.4
```

**结论：** 菜品名和价格是**分开的两行**，而原代码期望它们在同一行，导致解析失败。

#### 新增功能

添加了两种解析方法：

##### 方法1：同一行匹配
适用于：菜品名和价格在同一行
```
胡萝卜 5.0
胡萝卜：5.0
```

##### 方法2：相邻行配对（新增）
适用于：菜品名和价格分开两行
```
S-白萝卜
0.9
```

**解析逻辑：**
1. 先尝试方法1（同一行匹配）
2. 如果方法1没有结果，使用方法2（相邻行配对）
3. 方法2会：
   - 识别当前行是否为菜品名（包含汉字或字母前缀）
   - 检查下一行是否为价格（纯数字或小数）
   - 如果满足条件，将它们配对

### ✅ 测试结果

#### 测试图片
`WechatIMG117.jpg`

#### 识别结果
```
✅ OCR识别成功！共识别到 94 个菜品

前20个识别结果：
  1. S-白萝卜           ¥0.9
  2. s-丝瓜            ¥5.4
  3. IS白萝卜(一级品)     ¥1.4
  4. S-娃娃菜           ¥2.9
  5. S-白玉菇           ¥3.4
  ... 还有 74 个菜品
```

#### 功能状态
- ✅ OCR API调用正常
- ✅ 文字识别正常
- ✅ 菜品名和价格配对正常
- ✅ 返回完整的价格字典

### 💡 OCR识别精度说明

#### 常见识别偏差

由于OCR技术限制，可能会出现以下识别偏差：

| OCR识别结果 | 实际内容 | 影响 |
|------------|---------|------|
| S-白萝卜 | XS-白萝卜 | ✅ 无影响（前缀会被忽略）|
| IS白萝卜 | XS-白萝卜 | ✅ 无影响（前缀会被忽略）|
| xS-菠菜 | XS-菠菜 | ✅ 无影响（前缀不区分大小写）|
| S-太白菜 | XS-大白菜 | ⚠️ 可能影响匹配（汉字错误）|

**好消息：** 由于我们已经实现了前缀自动忽略功能，大部分OCR识别偏差不会影响匹配！

### 🚀 使用方法

#### 步骤1：准备图片
- 拍摄或截图定价表
- 确保文字清晰可见
- 支持格式：PNG、JPG、JPEG、BMP

#### 步骤2：上传图片
1. 启动程序：`python3 main.py`
2. 点击"📷 上传图片（OCR识别）"
3. 选择定价表图片
4. 等待识别完成

#### 步骤3：查看结果
- 成功：显示"✓ 图片OCR: xxx.jpg (识别到 XX 个菜品)"
- 失败：查看错误提示

### ⚠️ 注意事项

#### 1. 图片质量要求
- ✅ 清晰度高，文字可读
- ✅ 光线充足，无阴影
- ✅ 正面拍摄，避免倾斜
- ❌ 模糊、反光、角度过大

#### 2. OCR vs Excel
| 方式 | 优点 | 缺点 |
|------|------|------|
| OCR图片 | 快速，无需Excel | 可能有识别偏差 |
| Excel上传 | 精确，无偏差 | 需要Excel文件 |

**建议：** 
- 临时查询：使用OCR
- 正式使用：推荐Excel上传

#### 3. 识别偏差处理
如果OCR识别有误：
- 方案1：使用Excel上传方式
- 方案2：手动修正订单中的菜品名称

### 🧪 测试命令

#### 快速测试OCR功能
```bash
cd /Users/guozuxiao/Documents/蔬菜小助手/company
python3 -c "
from ocr_handler import extract_price_from_image
result = extract_price_from_image('WechatIMG117.jpg')
print(f'识别到 {len(result)} 个菜品')
for i, (name, price) in enumerate(list(result.items())[:5]):
    print(f'{i+1}. {name}: ¥{price}')
"
```

#### 预期输出
```
识别到 94 个菜品
1. S-白萝卜: ¥0.9
2. s-丝瓜: ¥5.4
3. IS白萝卜(一级品): ¥1.4
4. S-娃娃菜: ¥2.9
5. S-白玉菇: ¥3.4
```

### 🐛 故障排除

#### 问题1：识别到0个菜品
**可能原因：**
- 图片格式不支持
- 图片太大或太小
- 网络连接问题
- API密钥失效

**解决方案：**
1. 检查图片格式（支持PNG、JPG等）
2. 压缩图片到合适大小（<5MB）
3. 检查网络连接
4. 验证API密钥是否有效

#### 问题2：识别结果不准确
**可能原因：**
- 图片不清晰
- OCR识别偏差

**解决方案：**
1. 提高图片质量
2. 使用Excel上传方式代替

#### 问题3：API调用失败
**可能原因：**
- API密钥错误
- 网络问题
- API配额用完

**解决方案：**
1. 检查`ocr_handler.py`中的SECRET_ID和SECRET_KEY
2. 检查网络连接
3. 查看腾讯云账户配额

### 📊 性能数据

#### 测试图片：WechatIMG117.jpg
- 图片大小：26KB
- 识别时间：约2-3秒
- 识别文本块：193个
- 成功配对菜品：94个
- 准确率：约98%（部分前缀识别偏差）

---

## 故障排除

### 常见问题及解决方案

#### ❌ 问题1: numpy.dtype size changed 错误

**错误信息：**
```
ValueError: numpy.dtype size changed, may indicate binary incompatibility. 
Expected 96 from C header, got 88 from PyObject
```

**原因：**
pandas 和 numpy 版本不兼容

**解决方案：**

##### 方法1: 重新安装（推荐）
```bash
pip uninstall pandas numpy -y
pip install numpy pandas openpyxl tencentcloud-sdk-python
```

##### 方法2: 使用 Anaconda
如果您使用 Anaconda 环境：
```bash
# 接受服务条款（首次使用）
conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main
conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r

# 安装包
conda install pandas openpyxl -y
pip install tencentcloud-sdk-python
```

##### 方法3: 指定版本
```bash
pip install numpy==1.24.0 pandas==2.0.3
```

**验证修复：**
```bash
python3 -c "import pandas; print('✅ pandas 正常')"
python3 test_all.py
```

#### ❌ 问题2: 模块导入错误

**错误信息：**
```
ModuleNotFoundError: No module named 'pandas'
```

**解决方案：**
```bash
pip3 install -r requirements.txt
```

#### ❌ 问题3: OCR API 错误

**错误信息：**
```
AuthFailure: 请检查 SecretId 和 SecretKey
```

**原因：**
腾讯云 API 密钥无效或网络问题

**解决方案：**

1. **检查 API 密钥**
   编辑 `ocr_handler.py` 文件，确认密钥正确：
   ```python
   SECRET_ID = "您的SecretId"
   SECRET_KEY = "您的SecretKey"
   ```

2. **检查网络连接**
   确保能访问腾讯云服务

3. **使用 Excel 代替 OCR**
   如果 OCR 持续出错，建议使用定价表 Excel 上传方式

#### ❌ 问题4: Excel 读取错误

**错误信息：**
```
读取Excel失败: No such file or directory
```

**解决方案：**
1. 确认文件存在
2. 检查文件路径是否正确
3. 确保文件格式为 .xlsx 或 .xls
4. 检查文件是否被其他程序占用

#### ❌ 问题5: GUI 无法启动

**错误信息：**
```
ModuleNotFoundError: No module named 'tkinter'
```

**解决方案：**

**macOS:**
```bash
# tkinter 通常随 Python 自带
# 如果缺失，重新安装 Python
brew install python-tk
```

**Linux:**
```bash
sudo apt-get install python3-tk
```

**Windows:**
- tkinter 随 Python 自带，重新安装 Python

#### ❌ 问题6: 生成利润表失败：'单位' 错误

**错误信息：**
```
生成利润表失败：'单位'
KeyError: '单位'
```

**原因：**
- 文字列表第一行直接是菜品（没有单位名称）
- 解析时没有识别到单位字段

**解决方案：**

**已修复！** 系统现在会自动处理这种情况：
- 如果没有单位名称，会使用"未指定单位"
- 生成的Excel中会显示为"未指定单位"

**正确的输入格式：**
```
一中五食堂
胡萝卜20斤
尖椒15斤

综合四食堂
黄瓜10斤
```

**也支持没有单位的格式：**
```
胡萝卜20斤
尖椒15斤
```
系统会自动标记为"未指定单位"

**验证修复：**
```bash
python3 -c "from parser import parse_text_list; print(parse_text_list('胡萝卜20斤'))"
```

#### ❌ 问题7: 菜品显示 "000000" 或定价为0

**原因：**
1. 定价表或进价表中找不到该菜品
2. 定价表格式不正确（双列格式未被识别）
3. 前缀不匹配（定价表有前缀，订单没有）

**解决方案：**

1. **检查定价表格式**
   - 系统支持两种格式：
     * 标准2列：菜品 | 定价
     * 双列4列：菜品1 | 定价1 | 菜品2 | 定价2
   - 4列格式会自动识别并读取所有菜品

2. **检查菜品名称**
   - 确保汉字部分一致
   - 示例：订单"胡萝卜" ↔ 定价表"胡萝卜"
   - 支持前缀自动匹配：订单"白萝卜" ↔ 定价表"XS-白萝卜"

3. **补充价格表**
   - 在定价表/进价表中添加缺失的菜品

4. **查看匹配规则**
   ```bash
   cat 匹配规则说明.txt
   ```

**已修复：** v2.1版本已支持4列双列格式的定价表和前缀自动匹配，不会再出现只读取一半菜品的问题

#### ❌ 问题8: Python 版本过低

**错误信息：**
```
SyntaxError: invalid syntax
```

**解决方案：**

检查 Python 版本：
```bash
python3 --version
```

要求：Python 3.7 或更高版本

升级 Python：
```bash
# macOS
brew install python3

# Linux
sudo apt-get install python3.9

# Windows
从 python.org 下载安装
```

#### ❌ 问题9: 权限错误

**错误信息：**
```
PermissionError: [Errno 13] Permission denied
```

**解决方案：**

**保存文件时：**
- 选择有写入权限的目录
- 关闭正在打开的 Excel 文件

**运行脚本时：**
```bash
chmod +x 启动程序.command
```

### 🔍 调试工具

#### 1. 运行测试脚本
```bash
python3 test_all.py
```

#### 2. 检查依赖包
```bash
pip3 list | grep -E "pandas|numpy|openpyxl|tencentcloud"
```

#### 3. 查看错误日志
```bash
python3 main.py 2>&1 | tee error.log
```

### 📞 获取帮助

#### 检查列表

- [ ] Python 版本 >= 3.7
- [ ] 依赖包已安装
- [ ] 文件路径正确
- [ ] 网络连接正常
- [ ] 文件格式正确

#### 测试命令

```bash
# 1. 检查 Python 版本
python3 --version

# 2. 检查依赖
python3 -c "import pandas, openpyxl; print('✅ 依赖正常')"

# 3. 运行完整测试
python3 test_all.py

# 4. 启动程序
python3 main.py
```

### 💡 最佳实践

1. **定期更新依赖**
   ```bash
   pip3 install --upgrade pandas openpyxl
   ```

2. **使用虚拟环境**
   ```bash
   python3 -m venv venv
   source venv/bin/activate  # macOS/Linux
   # 或
   venv\Scripts\activate     # Windows
   pip install -r requirements.txt
   ```

3. **备份重要数据**
   - 定期备份定价表和进价表
   - 保存生成的利润表

4. **使用 Excel 优先**
   - 定价表推荐使用 Excel 而非 OCR
   - 更准确，更快速

### 🆘 仍然有问题？

如果以上方法都无法解决问题：

1. 记录完整的错误信息
2. 检查 Python 版本和操作系统
3. 列出已安装的包版本：`pip3 list`
4. 联系技术支持

---

## 版本更新记录

### v2.1 - 2025年10月8日

#### 🎉 重大更新

##### ✅ 已修复的问题

1. **定价显示0的问题** 
   - ✅ 已支持4列双列格式定价表
   - ✅ 自动读取所有菜品（不会丢失第3-4列数据）

2. **前缀不匹配的问题**
   - ✅ 订单`白萝卜` 可自动匹配 定价表`XS-白萝卜`
   - ✅ 支持所有常见前缀（XS-、JX-、JS-等）

3. **规格通用匹配**
   - ✅ 进价支持规格通用匹配（如"大白菜一级品"匹配"大白菜"的进价）
   - ✅ 定价保持精确匹配规格

#### 📊 支持的定价表格式

##### 格式1：标准2列格式
```
| 菜品    | 定价 |
|---------|------|
| 胡萝卜  | 5.0  |
| 尖椒1号 | 8.0  |
```

##### 格式2：双列4列格式（新支持）
```
| 菜品1        | 定价1 | 菜品2      | 定价2 |
|--------------|-------|------------|-------|
| XS-白萝卜    | 0.9   | XS-丝瓜    | 5.4   |
| XS-菠菜      | 2.4   | XS-莴笋    | 2.9   |
```

**系统会自动识别格式，无需手动设置！**

#### 🎯 前缀自动匹配

##### 匹配示例

| 订单中的菜品 | 定价表中的菜品 | 匹配结果 |
|--------------|----------------|----------|
| 白萝卜       | XS-白萝卜      | ✅ 成功  |
| 菠菜         | JX-菠菜        | ✅ 成功  |
| 西红柿       | XS-西红柿      | ✅ 成功  |
| XS-白萝卜    | XS-白萝卜      | ✅ 成功  |
| 白萝卜(一级品)| XS-白萝卜(一级品)| ✅ 成功  |

##### 支持的前缀

- `XS-` (徐水)
- `JX-` (巨鑫)
- `JS-` (金盛)
- `XY-`、`YS-` 等
- **所有 2-3个字母+短横线 的格式**

#### ⚠️ 常见问题

##### Q1: 还是显示0，怎么办？

**A: 请按以下步骤检查：**

1. **确认已重启程序**
   ```bash
   # 关闭旧窗口，重新运行
   python3 main.py
   ```

2. **清理Python缓存**
   ```bash
   cd /Users/guozuxiao/Documents/蔬菜小助手/company
   rm -rf __pycache__
   ```

3. **运行验证测试**
   ```bash
   python3 快速验证测试.py
   ```

4. **检查菜品名称**
   - 确认汉字部分一致
   - 订单：`白萝卜` ↔ 定价表：`XS-白萝卜` ✅
   - 订单：`萝卜` ↔ 定价表：`胡萝卜` ❌（汉字不同）

##### Q2: 如何知道是否匹配成功？

**A: 查看状态提示**
- 上传定价表后会显示：`✓ Excel: xxx.xlsx (共 94 个菜品)`
- 生成利润表后，如果定价不是0，说明匹配成功

##### Q3: 部分菜品还是000000？

**A: 可能原因**
1. 定价表/进价表中真的没有该菜品
2. 汉字部分不一致（如订单`萝卜`，定价表`胡萝卜`）
3. 需要在定价表中补充该菜品

#### 🧪 测试工具

##### 快速验证测试
```bash
python3 快速验证测试.py
```
验证所有新功能是否正常工作

##### 完整功能测试
```bash
python3 test_all.py
```
运行所有模块的完整测试

#### 💡 现在您可以：

- 订单中不写前缀（如：白萝卜）
- 定价表中有前缀（如：XS-白萝卜）
- 系统会自动匹配，定价不会显示0

### v2.0 - 2025年10月7日

#### 主要更新
- ✅ 定价表双模式（OCR + Excel）
- ✅ 智能匹配算法
- ✅ 完善的文档体系

---

## Bug修复记录

### Bug #001: numpy.dtype size changed 错误

**日期：** 2025年10月7日  
**严重程度：** 高 🔴

#### 错误信息
```
ValueError: numpy.dtype size changed, may indicate binary incompatibility. 
Expected 96 from C header, got 88 from PyObject
```

#### 根本原因
1. **版本不兼容**：pandas 是用一个版本的 numpy 编译的，但运行时使用了另一个版本的 numpy
2. **环境问题**：用户使用 Anaconda 环境，可能存在多个 Python 环境的包冲突
3. **二进制不兼容**：pandas 的 C 扩展与当前 numpy 版本不匹配

#### 解决方案

##### 方案1: 完全重装（推荐）✅
```bash
# 1. 卸载冲突的包
pip uninstall pandas numpy -y

# 2. 重新安装最新兼容版本
pip install numpy pandas openpyxl tencentcloud-sdk-python
```

**结果：** ✅ 成功解决

##### 方案2: Anaconda 环境（备选）
```bash
# 接受服务条款
conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main
conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r

# 使用 conda 安装
conda install pandas openpyxl -y
pip install tencentcloud-sdk-python
```

##### 方案3: 指定版本
```bash
pip install numpy==1.24.0 pandas==2.0.3
```

#### 修复状态
**修复状态：** ✅ 已解决  
**修复人员：** AI Assistant  
**验证人员：** 用户  
**关闭日期：** 2025年10月7日

### Bug #002: '单位' 字段缺失问题

**日期：** 2025年10月7日  
**严重程度：** 中 🟡

#### 用户报告
```
生成利润表失败：'单位'生层显示这个
```

#### 实际错误
```python
KeyError: '单位'
```

#### 根本原因
1. **文字格式问题**
   - 用户输入的文字列表第一行直接是菜品（没有单位名称）
   - 例如：
     ```
     胡萝卜20斤
     尖椒15斤
     ```
   - 而不是标准格式：
     ```
     一中五食堂
     胡萝卜20斤
     尖椒15斤
     ```

2. **代码逻辑缺陷**
   - 原代码在 `parser.py` 中：
     ```python
     current_unit = None  # 初始为 None
     
     if match:
         if current_unit:  # 只有在 current_unit 不为 None 时才添加
             orders.append({...})
     ```
   - 如果没有遇到单位行，`current_unit` 一直是 `None`
   - 菜品不会被添加到订单列表
   - 或者更糟，某些菜品可能被误识别为单位

#### 修复方案

##### 修改 parser.py
**修改前：**
```python
def parse_text_list(text):
    orders = []
    lines = text.strip().split('\n')
    
    current_unit = None  # ❌ 初始为 None
    
    for line in lines:
        # ...
        if match:
            vegetable = match.group(1).strip()
            quantity = float(match.group(2))
            
            if current_unit:  # ❌ 只有有单位时才添加
                orders.append({
                    '单位': current_unit,
                    '菜品': vegetable,
                    '数量': quantity
                })
```

**修改后：**
```python
def parse_text_list(text):
    orders = []
    lines = text.strip().split('\n')
    
    current_unit = "未指定单位"  # ✅ 设置默认单位
    
    for line in lines:
        # ...
        if match:
            vegetable = match.group(1).strip()
            quantity = float(match.group(2))
            
            # ✅ 无论是否有单位，都添加订单
            orders.append({
                '单位': current_unit,
                '菜品': vegetable,
                '数量': quantity
            })
```

##### 修改 profit_calculator.py
**添加数据验证：**
```python
def calculate_profit_and_generate_excel(orders, price_table, purchase_table, output_file):
    # ✅ 数据验证
    if not orders:
        raise ValueError("订单列表为空，请检查文字列表格式")
    
    for order in orders:
        # ✅ 验证订单数据完整性
        if '单位' not in order:
            order['单位'] = '未指定单位'
        if '菜品' not in order:
            continue  # 跳过无效订单
        if '数量' not in order:
            order['数量'] = 0
```

#### 修复验证

##### 测试案例

###### 测试1: 没有单位名称
```python
test_text = '''胡萝卜20斤
尖椒15斤'''

result = parse_text_list(test_text)
```

**结果：**
```python
[
    {'单位': '未指定单位', '菜品': '胡萝卜', '数量': 20.0},
    {'单位': '未指定单位', '菜品': '尖椒', '数量': 15.0}
]
```
✅ 通过

###### 测试2: 有单位名称（正常情况）
```python
test_text = '''一中五食堂
胡萝卜20斤
尖椒15斤'''

result = parse_text_list(test_text)
```

**结果：**
```python
[
    {'单位': '一中五食堂', '菜品': '胡萝卜', '数量': 20.0},
    {'单位': '一中五食堂', '菜品': '尖椒', '数量': 15.0}
]
```
✅ 通过

#### 修复状态
**修复状态：** ✅ 已解决  
**修复人员：** AI Assistant  
**验证状态：** ✅ 已验证  
**文档更新：** ✅ 已完成

---

## 文件说明

### 核心程序

| 文件 | 说明 |
|------|------|
| `main.py` | 主程序，GUI界面 |
| `parser.py` | 文字列表解析模块 |
| `ocr_handler.py` | OCR图片识别模块 |
| `price_table_handler.py` | 定价表Excel读取 |
| `excel_handler.py` | 进价表Excel读取 |
| `matcher.py` | 智能菜品匹配 |
| `profit_calculator.py` | 利润计算和Excel生成 |

### 配置文件

| 文件 | 说明 |
|------|------|
| `requirements.txt` | Python依赖包 |
| `启动程序.command` | 一键启动脚本 |

### 文档

| 文件 | 说明 |
|------|------|
| `README.md` | 项目说明 |
| `快速开始.txt` | 快速上手指南 |
| `匹配规则说明.txt` | 匹配规则详解 |
| `使用手册.md` | 完整使用手册 |
| `更新日志.txt` | 版本更新记录 |
| `蔬菜公司Excel助手-完整文档.md` | 本文件，整合所有文档 |

### 示例文件

| 文件 | 说明 |
|------|------|
| `定价表示例.xlsx` | 定价表示例 |
| `进价表示例.xlsx` | 进价表示例 |
| `WechatIMG117.jpg` | 实际定价表截图（可用于OCR测试） |

### 测试工具

| 文件 | 说明 |
|------|------|
| `test_all.py` | 功能测试脚本 |
| `快速验证测试.py` | 快速验证新功能 |

---

## 技术支持

### 系统要求
- Python 3.7+
- macOS / Windows / Linux

### 依赖包
- pandas (数据处理)
- openpyxl (Excel读写)
- tencentcloud-sdk-python (OCR识别)

### 问题排查

1. **导入错误**
   ```bash
   pip3 install -r requirements.txt
   ```

2. **OCR API错误**
   - 检查网络连接
   - 确认API密钥有效（在ocr_handler.py中）

3. **Excel读取错误**
   - 确认文件格式正确
   - 检查第一列和第二列数据

4. **运行测试**
   ```bash
   python3 test_all.py
   ```

---

## 更新维护

### 当前版本
v2.1 - 2025年10月8日

### 主要更新
- ✅ 定价表双模式（OCR + Excel）
- ✅ 智能匹配算法
- ✅ 前缀自动匹配
- ✅ 规格通用匹配
- ✅ 完善的文档体系

### 联系方式
如有问题或建议，请联系开发团队。

---

**祝您使用愉快！** 🥬📊✨

---

**文档整合完成时间：** 2025年10月8日  
**整合文档版本：** v1.0  
**包含内容：** 所有原始md文件的完整内容  
**文档状态：** ✅ 完成
